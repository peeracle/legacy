/*!
 * peeracle v0.0.1 (https://github.com/peeracle/peeracle)
 * Copyright 2015
 * Licensed under MIT
 */
"use strict";var Peeracle={};Peeracle.Media={},Peeracle.Tracker={},function(){var a=null,b=function(b){if(!a){var c;a=[];for(var d=0;256>d;d++){c=d;for(var e=0;8>e;e++)c=1&c?3988292384^c>>>1:c>>>1;a[d]=c}}for(var f=-1,g=0,h=b.length;h>g;g++)f=f>>>8^a[255&(f^b[g])];return(-1^f)>>>0},c={Crc32:b};Peeracle.Utils=c}(),function(){function a(a){var b=a,c=0,d="Blob"==typeof a?a.size:-1,e=function(){return c},f=function(a){c+=a},g=function(a){c=a},h=function(a,e){if(d>-1&&c+a>d)return void e(null);if("undefined"==typeof module){var f=new FileReader;f.onload=function(a){e(new Uint8Array(a.target.result))},f.readAsArrayBuffer(b.slice(c,c+a))}else"string"==typeof b?_nodeOpen(function(){_nodeFetchBytes(a,e)}):_nodeFetchBytes(a,e)};return{getOffset:e,fetchBytes:h,read:f,seek:g}}Peeracle.File=a}(),function(){var a=function(){return[26,69,223,163]},b=function(a){var b=a,c=null,d=function(a,b,c){var d,e=1,f=128,g=1;if(d=a[b],!d)return null;for(;c>=e&&!(d&f);)e++,f>>=1;if(e>c)return null;for(d&=~f;g++<e;)d=d<<8|a[++b];return{length:e,value:d}},e=function(a,b){var c=d(b,a,4),e={};return e.id=c.value|1<<7*c.length,e.str=e.id.toString(16),e.headerSize=c.length,c=d(b,a+e.headerSize,8),e.dataSize=c.value,e.headerSize+=c.length,e},f=function(a){var c=b.getOffset();b.fetchBytes(12,function(d){if(!d)return void a(null);var f=e(0,d);b.read(f.headerSize),f.headerOffset=c,a(f)})},g=function(a,b,c){if(1>c||c>8)return null;for(var d=0,e=0;c>e;++e)d<<=8,d|=255&a[b+e];return d},h=function(a,c){b.seek(a.headerOffset),b.fetchBytes(a.headerSize+a.dataSize,function(d){return d?(b.read(a.headerSize+a.dataSize),void c(d)):void c(null)})},i=function(a){var b=0,c=e(b,a);return"1f43b675"!==c.str?null:(b=c.headerSize,c=e(b,a),"e7"!==c.str?null:(b+=c.headerSize,g(a,b,c.dataSize)))},j=function(a){f(function(d){return"1a45dfa3"!==d.str?void a(null):(b.read(d.dataSize),void f(function e(g){return"1f43b675"===g.str?(c=g,d.dataSize=g.headerOffset-d.headerSize,void h(d,function(b){a(b)})):("18538067"!==g.str&&b.read(g.dataSize),void f(e))}))})},k=function(a){return null==c?void a(null):void h(c,function(b){f(function(d){c=d&&"1f43b675"===d.str?d:null,a({timecode:i(b),bytes:b})})})};return{getInitSegment:j,getNextMediaSegment:k}},c=function(a){return new b(a)},d={WebM:{getFileHeader:a,create:c}};Peeracle.Media.WebM=d.WebM}(),function(){function a(){var a=function(a,c){a.fetchBytes(4,function(d){if(!d||4!==d.length)return void c(null);var e=null;a.seek(0);for(var f in b){var g=b[f].getFileHeader();if(g[0]===d[0]&&g[1]===d[1]&&g[2]===d[2]&&g[3]===d[3]){e=b[f].create(a);break}}return e?void c(e):void c(null)})},d=function(a){var b,c=40960,d=a/(c/20);for(b=16384;1048576>b&&d>b;b*=2);return b},e=function(b,e,f){a(b,function(a){if(!a)return void e(null);var g={hash:null,tracker:"ws://tracker.dotstar.fr:8080",init:null,chunksize:d(b.getFileLength()),clusters:[]};a.getInitSegment(function(b){g.init=b,g.hash=c.Crc32(b),a.getNextMediaSegment(function d(b){if(!b)return console.log(g.hash),void e(g);for(var h={timecode:b.timecode,size:b.bytes.length,chunks:[]},i=b.bytes.length,j=g.chunksize,k=0;i>k;k+=j){var l=b.bytes.subarray(k,k+j);h.chunks.push(c.Crc32(l)),f&&f(l.length),j>i-k&&(j=i-k)}g.clusters.push(h),a.getNextMediaSegment(d)})})})},f=function(){};return{create:e,load:f}}var b,c;"undefined"==typeof module?(b=Peeracle.Media,c=Peeracle.Utils):(b=require("./media"),c=require("./utils")),Peeracle.Metadata=a}(),function(){function a(){var a=function(a,b){for(var c=0;c<a.length;++c){var d=a.charCodeAt(c);b.push(d)}b.push(0)},b=function(a,b){var c=0,d=[];for(a>>>=0;4>c;)d.push(255&a),a>>=8,++c;d=d.reverse();for(var e=0;e<d.length;++e)b.push(d[e])},c=function(a,b){b.push(255&a)},d=function(a,c){for(var d=a.getMediaSegments(),e=0,f=d.length;f>e;++e)b(d[e][0],c),b(d[e][1],c),b(d[e][2],c)},e=function(a,c){var d=a.getInitSegment();b(d.length,c);for(var e=0,f=d.length;f>e;++e)c.push(d[e])},f=function(b,d){for(var e=b.getTrackers(),f=0;f<e.length;++f)a(e[f],d);c(0,d)},g=function(c,d){var e=c.getHeader();a(e.magic,d),b(e.version,d),a(e.checksum,d)},h=function(a){var b=[];return g(a,b),f(a,b),e(a,b),d(a,b),b};return{serialize:h}}Peeracle.MetadataSerializer=a}(),function(){function a(){var a=function(a){var b=a.splice(0,1);return b[0]},b=function(b){for(var c=[],d=0;4>d;++d)c.push(a(b));return(c[0]<<24)+(c[1]<<16)+(c[2]<<8)+c[3]>>>0},c=function(b){var c,d="";do{if(c=a(b),!c)break;d+=String.fromCharCode(c)}while(c);return d},d=function(b){var d,e=[];do{var f="";if(d=a(b),!d)break;f+=String.fromCharCode(d)+c(b),e.push(f)}while(d);return e},e=function(a){var d={};return d.magic=c(a),d.version=b(a),d.checksum=c(a),d},f=function(a){var c=b(a);return a.splice(0,c)},g=function(a){var c=[];do{var d=[];d.push(b(a)),d.push(b(a)),d.push(b(a)),c.push(d)}while(a.length);return c},h=function(a){var b=e(a),c=d(a),h=f(a),i=g(a);return{header:b,trackers:c,init:h,media:i}};return{unserialize:h}}Peeracle.MetadataUnserializer=a}(),function(){function a(a){var b,c=a,d=function(a){console.log("Peeracle.MediaChannel onerror",a)},e=function(a){console.log("Peeracle.MediaChannel onmessage",a.data)},f=function(){console.log("Peeracle.MediaChannel onopen")},g=function(){console.log("Peeracle.MediaChannel onclose")},h=function(a){b=a,b.onerror=d,b.onmessage=e,b.onopen=f,b.onclose=g},i=function(){b=c.createDataChannel("media"),h(b)},j=function(){return b.readyState};return{createDataChannel:i,setDataChannel:h,getReadyState:j}}Peeracle.MediaChannel=a}(),function(){function a(a){var b,c=a,d=function(a){console.log("Peeracle.SignalChannel onerror",a)},e=function(a){console.log("Peeracle.SignalChannel onmessage",a.data)},f=function(){console.log("Peeracle.SignalChannel onopen")},g=function(){console.log("Peeracle.SignalChannel onclose")},h=function(a){b=a,b.onerror=d,b.onmessage=e,b.onopen=f,b.onclose=g},i=function(){b=c.createDataChannel("signal"),h(b)},j=function(){return b.readyState};return{createDataChannel:i,setDataChannel:h,getReadyState:j}}Peeracle.SignalChannel=a}(),function(){function a(){var a,g,h,i=[],j=function(b){if(a&&b){var c=b.candidate;i.forEach(function(a){a.onIceCandidate(c)})}},k=function(b){a&&b&&i.forEach(function(b){b.onConnectionStateChange(a.iceConnectionState)})},l=function(){},m=function(){console.log("_onReadyStateChange")},n=function(a){a&&a.channel&&("signal"===a.channel.label?g.setDataChannel(a.channel):"media"===a.channel.label&&h.setDataChannel(a.channel))},o=function(){var b={iceServers:[{url:"stun:stun.l.google.com:19302"}]};a=new c(b),a.onicecandidate=j,a.oniceconnectionstatechange=k,a.onicegatheringstatechange=l,a.ondatachannel=n,a.onreadystatechange=m,g=new f(a),h=new e(a)},p=function(a){var b=i.indexOf(a);~b||i.push(a)},q=function(a){var b=i.indexOf(a);~b&&i.splice(b,1)},r=function(b,c){var d=function(a){c(a)};o(),h.createDataChannel(),g.createDataChannel(),a.createOffer(function(c){a.setLocalDescription(c,function(){b(c)},d)},d)},s=function(b,c,e){var f=function(a){e(a)};o();var g=new d(b);a.setRemoteDescription(g,function(){a.createAnswer(function(b){a.setLocalDescription(b,function(){c(b)},f)},f)},f)},t=function(b,c,e){var f=function(a){e(a)},g=new d(b);a.setRemoteDescription(g,function(){c()},f)},u=function(c,d,e){a.addIceCandidate(new b(c),function(){d()},function(a){e(a)})},v=function(){a.close()};return{subscribe:p,unsubscribe:q,createOffer:r,createAnswer:s,setAnswer:t,addIceCandidate:u,close:v}}var b,c,d,e,f;if("undefined"==typeof module?(e=Peeracle.MediaChannel,f=Peeracle.SignalChannel):(e=require("./mediachannel"),f=require("./signalchannel")),"undefined"==typeof module)b=window.mozRTCIceCandidate||window.webkitRTCIceCandidate||window.RTCIceCandidate,c=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,d=window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.RTCSessionDescription;else{var g=require("wrtc");c=g.RTCPeerConnection,d=g.RTCSessionDescription,b=g.RTCIceCandidate}Peeracle.Peer=a}(),function(){function a(){var a,b,c={},d=[],e=function(){console.log("Peeracle.Tracker: onOpen"),b.send(JSON.stringify({type:"hello"}))},f=function(a){console.log("Peeracle.Tracker: _onMessage",a.data);var b,e=function(a){a.id&&d.forEach(function(b){b.onConnect(a.id)})},f=function(a){a.hash&&a.peers&&c[a.hash]&&a.peers.forEach(function(b){c[a.hash].onEnter(b)})},g=function(a){a.hash&&a.id&&c[a.hash]&&c[a.hash].onLeave(a.id)},h=function(a){a.hash&&a.from&&a.data&&c[a.hash]&&c[a.hash].onSdp(a.from,a.data)},i={welcome:e,enter:f,leave:g,sdp:h};try{b=JSON.parse(a.data)}catch(j){return}i[b.type]&&i[b.type](b)},g=function(){console.log("Peeracle.Tracker: _onError")},h=function(){console.log("Peeracle.Tracker: _onClose")},i=function(c){a=c,b=new WebSocket(a,"prcl",a),b.onopen=e,b.onmessage=f,b.onerror=g,b.onclose=h},j=function(){d.forEach(function(a,b){a.onDisconnect(),d.splice(b,1)}),b.close()},k=function(a,d,e){c[a]||(c[a]=e),b.send(JSON.stringify({type:"announce",hash:a,got:d}))},l=function(a){c[a]&&delete c[a]},m=function(a,d,e){c[a]&&b.send(JSON.stringify({type:"sdp",hash:a,peer:d,data:e}))},n=function(a){var b=d.indexOf(a);~b||d.push(a)},o=function(a){var b=d.indexOf(a);~b&&d.splice(b,1)};return{connect:i,disconnect:j,announce:k,remove:l,sendSdp:m,subscribe:n,unsubscribe:o}}var b={Client:a};Peeracle.Tracker.Client=b.Client}();