/*!
 * peeracle v0.0.1 (https://github.com/peeracle/peeracle)
 * Copyright 2015
 * Licensed under MIT
 */
"use strict";var Peeracle={};Peeracle.Checksum={},Peeracle.Media={},Peeracle.Tracker={},function(){var a=function(){return"crc32"},b=function(){var a,b=null,c=function(){var a;b=[];for(var c=0;256>c;c++){a=c;for(var d=0;8>d;d++)a=1&a?3988292384^a>>>1:a>>>1;b[c]=a}},d=function(){b||c(),a=-1},e=function(c){for(var d=0,e=c.length;e>d;d++)a=a>>>8^b[255&(a^c[d])]},f=function(){return(-1^a)>>>0},g=function(a){return d(),e(a),f()},h=function(a,b){var c=0,d=[];for(a>>>=0;4>c;)d.push(255&a),a>>=8,++c;d=d.reverse();for(var e=0;e<d.length;++e)b.push(d[e])},i=function(a){for(var b=[],c=0;4>c;++c){var d=a.splice(0,1);b.push(d[0])}return(b[0]<<24)+(b[1]<<16)+(b[2]<<8)+b[3]>>>0};return{checksum:g,init:d,update:e,"final":f,serialize:h,unserialize:i}},c=function(){return new b},d={Crc32:{getIdentifier:a,create:c}};Peeracle.Checksum.Crc32=d.Crc32}(),function(){var a={};Peeracle.Utils=a}(),function(){function a(a){var b=a,c=0,d="string"!=typeof a?a.size:-1,e=function(){return d},f=function(){return c},g=function(a){c+=a},h=function(a){c=a},i=function(a,e){if(d>-1&&c+a>d)return void e(null);if("undefined"==typeof module){var f=new FileReader;f.onload=function(a){e(new Uint8Array(a.target.result))},f.readAsArrayBuffer(b.slice(c,c+a))}else _nodeFetchBytes(a,e)};return{getLength:e,getOffset:f,fetchBytes:i,read:g,seek:h}}Peeracle.File=a}(),function(){var a=function(){return[26,69,223,163]},b=function(a){var b=a,c=null,d={},e=function(a,b,c){var d,e=1,f=128,g=1;if(d=a[b],!d)return null;for(;c>=e&&!(d&f);)e++,f>>=1;if(e>c)return null;for(d&=~f;g++<e;)d=d<<8|a[++b];return{length:e,value:d}},f=function(a,b){var c=e(b,a,4),d={};return d.id=c.value|1<<7*c.length,d.str=d.id.toString(16),d.headerSize=c.length,c=e(b,a+d.headerSize,8),d.dataSize=c.value,d.headerSize+=c.length,d},g=function(a){var c=b.getOffset();b.fetchBytes(12,function(d){if(!d)return void a(null);var e=f(0,d);b.read(e.headerSize),e.headerOffset=c,a(e)})},h=function(a,b,c){if(1>c||c>8)return null;for(var d=0,e=0;c>e;++e)d<<=8,d|=255&a[b+e];return d},i=function(a,c){b.seek(a.headerOffset),b.fetchBytes(a.headerSize+a.dataSize,function(d){return d?(b.read(a.headerSize+a.dataSize),void c(d)):void c(null)})},j=function(a){var b=0,c=f(b,a);return"1f43b675"!==c.str?null:(b=c.headerSize,c=f(b,a),"e7"!==c.str?null:(b+=c.headerSize,h(a,b,c.dataSize)))},k=function(a){g(function(d){return"1a45dfa3"!==d.str?void a(null):(b.read(d.dataSize),void g(function e(f){return"1f43b675"===f.str?(c=f,d.dataSize=f.headerOffset-d.headerSize,void i(d,function(b){a(b)})):("18538067"!==f.str&&b.read(f.dataSize),void g(e))}))})},l=function(a){return null==c?void a(null):void i(c,function(b){g(function(e){c=e&&"1f43b675"===e.str?e:null;var f=j(b);d[f]=e,a({timecode:f,bytes:b})})})},m=function(a,b){if(!(a in d))return void b(null);var c=d[a];i(c,function(c){b({timecode:a,bytes:c})})};return{getInitSegment:k,getNextMediaSegment:l,getMediaSegmentAt:m}},c=function(a){return new b(a)},d={WebM:{getFileHeader:a,create:c}};Peeracle.Media.WebM=d.WebM}(),function(){function a(){var a,c,d="crc32",e=0,f=[],g=[],h={},i=function(){for(var a in b)if(b[a].getIdentifier()===d){c=b[a].create();break}if(!c)throw"Unknown checksum "+d},j=function(){if(!a){c||i(),c.init(),c.update(g);for(var b in h){c.update([h[b][1]]);for(var d=0,e=h[b][2].length;e>d;++d)c.update([h[b][2][d]])}a=c["final"]()}return a},k=function(){return d},l=function(){return e},m=function(){return f},n=function(){return g},o=function(){return h},p=function(a){d=a},q=function(a){e=a},r=function(a){f=a},s=function(a){g=a},t=function(a){h=a},u=function(a,b,d){var f=b.length,g=e;c||i(),h[a]=[f,c.checksum(b),[]];for(var j=0;f>j;j+=g){var k=b.subarray(j,j+g);h[a][2].push(c.checksum(k)),d&&d(k),g>f-j&&(g=f-j)}d&&d(null)},v=function(a,b){c||i();var d=0,e=[];for(var f in b)e[d++]=b[f];return h[a][1]===c.checksum(b)},w=function(a){var b,c=40960,d=a/(c/20);for(b=16384;1048576>b&&d>b;b*=2);e=b};return{getId:j,getChecksum:k,getChunkSize:l,getTrackers:m,getInitSegment:n,getMediaSegments:o,setChecksum:p,setChunkSize:q,setTrackers:r,setInitSegment:s,setMediaSegments:t,addMediaSegment:u,validateMediaSegment:v,calculateChunkSize:w}}var b;b="undefined"==typeof module?Peeracle.Checksum:require("./checksum"),Peeracle.Metadata=a}(),function(){function a(){var a,c=function(a,b){for(var c=0;c<a.length;++c){var d=a.charCodeAt(c);b.push(d)}b.push(0)},d=function(a,b){var c=0,d=[];for(a>>>=0;4>c;)d.push(255&a),a>>=8,++c;d=d.reverse();for(var e=0;e<d.length;++e)b.push(d[e])},e=function(a,b){b.push(255&a)},f=function(b,c){a.serialize(b,c)},g=function(e,f){var g=e.getChecksum(),h=e.getChunkSize();for(var i in b)if(b[i].getIdentifier()===g){a=b[i].create();break}if(!a)throw"Unknown checksum "+g;c("PRCL",f),d(1,f),c(g,f),d(h,f)},h=function(a,b){for(var d=a.getTrackers(),f=0;f<d.length;++f)c(d[f],b);e(0,b)},i=function(a,b){var c=a.getInitSegment();d(c.length,b);for(var e=0,f=c.length;f>e;++e)b.push(c[e])},j=function(a,b){var c=a.getMediaSegments();for(var e in c){d(e,b),d(c[e][0],b),f(c[e][1],b),d(c[e][2].length,b);for(var g=0,h=c[e][2].length;h>g;++g)f(c[e][2][g],b)}},k=function(a){var b=[];return g(a,b),h(a,b),i(a,b),j(a,b),b};return{serialize:k}}var b;b="undefined"==typeof module?Peeracle.Checksum:require("./checksum"),Peeracle.MetadataSerializer=a}(),function(){function a(){var a,c=function(a){var b=a.splice(0,1);return b[0]},d=function(a){for(var b=[],d=0;4>d;++d)b.push(c(a));return(b[0]<<24)+(b[1]<<16)+(b[2]<<8)+b[3]>>>0},e=function(a){var b,d="";do{if(b=c(a),!b)break;d+=String.fromCharCode(b)}while(b);return d},f=function(b){var c=a.unserialize(b);return c},g=function(a){var b=d(a);return a.splice(0,b)},h=function(c){var f={};f.magic=e(c),f.version=d(c),f.checksum=e(c),f.chunksize=d(c);for(var g in b)if(b[g].getIdentifier()===f.checksum){a=b[g].create();break}if(!a)throw"Unknown checksum "+f.checksum;return f},i=function(a){var b,d=[];do{var f="";if(b=c(a),!b)break;f+=String.fromCharCode(b)+e(a),d.push(f)}while(b);return d},j=function(a){var b={};do{var c,e=d(a),g=[],h=[];g.push(d(a)),g.push(f(a)),c=d(a);for(var i=0;c>i;++i)h.push(f(a));g.push(h),b[e]=g}while(a.length);return b},k=function(a,b){var c=h(a),d=i(a),e=g(a),f=j(a);b.setChecksum(c.checksum),b.setChunkSize(c.chunksize),b.setTrackers(d),b.setInitSegment(e),b.setMediaSegments(f)};return{unserialize:k}}var b;b="undefined"==typeof module?Peeracle.Checksum:require("./checksum"),Peeracle.MetadataUnserializer=a}(),function(){function a(a){var b,c=a,d=function(a){console.log("Peeracle.MediaChannel onerror",a)},e=function(a){console.log("Peeracle.MediaChannel onmessage",a.data)},f=function(){console.log("Peeracle.MediaChannel onopen")},g=function(){console.log("Peeracle.MediaChannel onclose")},h=function(a){b=a,b.onerror=d,b.onmessage=e,b.onopen=f,b.onclose=g},i=function(){b=c.createDataChannel("media"),h(b)},j=function(){return b.readyState};return{createDataChannel:i,setDataChannel:h,getReadyState:j}}Peeracle.MediaChannel=a}(),function(){function a(a){var b,c=a,d=function(a){console.log("Peeracle.SignalChannel onerror",a)},e=function(a){console.log("Peeracle.SignalChannel onmessage",a.data)},f=function(){console.log("Peeracle.SignalChannel onopen")},g=function(){console.log("Peeracle.SignalChannel onclose")},h=function(a){b=a,b.onerror=d,b.onmessage=e,b.onopen=f,b.onclose=g},i=function(){b=c.createDataChannel("signal"),h(b)},j=function(){return b.readyState};return{createDataChannel:i,setDataChannel:h,getReadyState:j}}Peeracle.SignalChannel=a}(),function(){function a(){var a,g,h,i=[],j=function(b){if(a&&b){var c=b.candidate;i.forEach(function(a){a.onIceCandidate(c)})}},k=function(b){a&&b&&i.forEach(function(b){b.onConnectionStateChange(a.iceConnectionState)})},l=function(){},m=function(){console.log("_onReadyStateChange")},n=function(a){a&&a.channel&&("signal"===a.channel.label?g.setDataChannel(a.channel):"media"===a.channel.label&&h.setDataChannel(a.channel))},o=function(){var b={iceServers:[{url:"stun:stun.l.google.com:19302"}]};a=new c(b),a.onicecandidate=j,a.oniceconnectionstatechange=k,a.onicegatheringstatechange=l,a.ondatachannel=n,a.onreadystatechange=m,g=new f(a),h=new e(a)},p=function(a){var b=i.indexOf(a);~b||i.push(a)},q=function(a){var b=i.indexOf(a);~b&&i.splice(b,1)},r=function(b,c){var d=function(a){c(a)};o(),h.createDataChannel(),g.createDataChannel(),a.createOffer(function(c){a.setLocalDescription(c,function(){b(c)},d)},d)},s=function(b,c,e){var f=function(a){e(a)};o();var g=new d(b);a.setRemoteDescription(g,function(){a.createAnswer(function(b){a.setLocalDescription(b,function(){c(b)},f)},f)},f)},t=function(b,c,e){var f=function(a){e(a)},g=new d(b);a.setRemoteDescription(g,function(){c()},f)},u=function(c,d,e){a.addIceCandidate(new b(c),function(){d()},function(a){e(a)})},v=function(){a.close()};return{subscribe:p,unsubscribe:q,createOffer:r,createAnswer:s,setAnswer:t,addIceCandidate:u,close:v}}var b,c,d,e,f;if("undefined"==typeof module?(e=Peeracle.MediaChannel,f=Peeracle.SignalChannel):(e=require("./mediachannel"),f=require("./signalchannel")),"undefined"==typeof module)b=window.mozRTCIceCandidate||window.webkitRTCIceCandidate||window.RTCIceCandidate,c=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,d=window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.RTCSessionDescription;else{var g=require("wrtc");c=g.RTCPeerConnection,d=g.RTCSessionDescription,b=g.RTCIceCandidate}Peeracle.Peer=a}(),function(){function a(){var a,b,c={},d=[],e=function(){console.log("Peeracle.Tracker: onOpen"),b.send(JSON.stringify({type:"hello"}))},f=function(a){console.log("Peeracle.Tracker: _onMessage",a.data);var b,e=function(a){a.id&&d.forEach(function(b){b.onConnect(a.id)})},f=function(a){a.hash&&a.peers&&c[a.hash]&&a.peers.forEach(function(b){c[a.hash].onEnter(b)})},g=function(a){a.hash&&a.id&&c[a.hash]&&c[a.hash].onLeave(a.id)},h=function(a){a.hash&&a.from&&a.data&&c[a.hash]&&c[a.hash].onSdp(a.from,a.data)},i={welcome:e,enter:f,leave:g,sdp:h};try{b=JSON.parse(a.data)}catch(j){return}i[b.type]&&i[b.type](b)},g=function(){console.log("Peeracle.Tracker: _onError")},h=function(){console.log("Peeracle.Tracker: _onClose")},i=function(c){a=c,b=new WebSocket(a,"prcl",a),b.onopen=e,b.onmessage=f,b.onerror=g,b.onclose=h},j=function(){d.forEach(function(a,b){a.onDisconnect(),d.splice(b,1)}),b.close()},k=function(a,d,e){c[a]||(c[a]=e),b.send(JSON.stringify({type:"announce",hash:a,got:d}))},l=function(a){c[a]&&delete c[a]},m=function(a,d,e){c[a]&&b.send(JSON.stringify({type:"sdp",hash:a,peer:d,data:e}))},n=function(a){var b=d.indexOf(a);~b||d.push(a)},o=function(a){var b=d.indexOf(a);~b&&d.splice(b,1)};return{connect:i,disconnect:j,announce:k,remove:l,sendSdp:m,subscribe:n,unsubscribe:o}}var b={Client:a};Peeracle.Tracker.Client=b.Client}();