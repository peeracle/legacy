/*
 * Copyright (c) 2015 peeracle contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

"use strict";var Peeracle={},RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,RTCSessionDescription=window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.RTCSessionDescription,RTCIceCandidate=window.mozRTCIceCandidate||window.webkitRTCIceCandidate||window.RTCIceCandidate;Peeracle.BinaryStream=function(){function a(a){this.bytes=a,this.length_=a.length,this.offset_=0}return a.prototype.readByte=function(){if(this.offset_>=this.length_)throw"Index out of bounds";return this.bytes[this.offset_++]},a.prototype.writeByte=function(a){if(this.offset_>=this.length_)throw"Index out of bounds";this.bytes.set([a],this.offset_++)},a.prototype.readBytes=function(a){if(this.offset_>=this.offset_+this.length_)throw"Index out of bounds";var b=this.bytes.slice(this.offset_,a);return this.offset_+=a,b},a.prototype.writeBytes=function(a){var b=a.length;if(this.offset_>=this.offset_+b)throw"Index out of bounds";this.bytes.set(a,this.offset_),this.offset_+=b},a.prototype.readFloat8=function(){var a=this.readBytes(8),b=a[0]>>7&1,c=((127&a[0])<<4|a[1]>>4&15)-1023,d=0,e=Math.pow(2,48);d+=(15&a[1])*e;for(var f=2;8>f;++f)e=Math.pow(2,8*(8-f-1)),d+=(255&a[f])*e;if(c>-1023){if(1024===c)return 0===d?0===b?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:0/0;d+=4503599627370496}else{if(0===d)return 0;c=-1022}return Math.pow(-1,b)*d*Math.pow(2,-52)*Math.pow(2,c)},a.prototype.writeFloat8=function(a){var b=0,c=0;switch(a){case Number.POSITIVE_INFINITY:b=2146435072;break;case Number.NEGATIVE_INFINITY:b=4293918720;break;case 0:b=1073741824;break;case-0:b=3221225472;break;default:if(Number.isNaN(a)){b=2146959360;break}-0>=a&&(b=2147483648,a=-a);var d=Math.floor(Math.log(a)/Math.log(2)),e=Math.floor(a/Math.pow(2,d)*Math.pow(2,52));c=4294967295&e,e/=Math.pow(2,32),d+=1023,d>=2047?(d=2047,e=0):0>d&&(d=0),b|=d<<20,b|=1048575&e}this.writeUInt32(b),this.writeUInt32(c)},a.prototype.readInt32=function(a){var b=this.readBytes(4),c=(b[0]<<24)+(b[1]<<16)+(b[2]<<8);return a?c+b[3]>>>0:c+b[3]},a.prototype.writeInt32=function(a,b){var c=0,d=new Uint8Array(4);for(b&&(a>>>=0);4>c;)d[c]=255&a,a>>=8,++c;this.writeBytes(d)},a.prototype.readUInt32=function(){return this.readInt32(!0)},a.prototype.writeUInt32=function(a){this.writeInt32(a,!0)},a.prototype.readString=function(a){var b="";if(a){for(var c=this.readBytes(a),d=0;a>d;++d)b+=String.fromCharCode(c[d]);return b}for(var e=this.readByte();e;)b+=String.fromCharCode(e),e=this.readByte();return b},a.prototype.writeString=function(a){for(var b=a.length,c=new Uint8Array(b),d=0;b>d;++d)c[d]=a.charCodeAt(d);this.writeBytes(c)},a}(),Peeracle.Crypto=function(){function a(){}return a.createInstance=function(b){for(var c in a)if(a.hasOwnProperty(c)&&a[c].hasOwnProperty("getIdentifier")&&a[c].getIdentifier()===b)return new a[c];return null},a.prototype.checksum=function(){},a.prototype.init=function(){},a.prototype.update=function(){},a.prototype.finish=function(){},a.prototype.serialize=function(){},a.prototype.unserialize=function(){},a}(),Peeracle.Crypto.Crc32=function(){function a(){this.crc_=null,this.crcTable_=null}var b=Peeracle.Crypto;return a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.getIdentifier=function(){return"crc32"},a.prototype.generateCrc32Table_=function(){var a;this.crcTable_=[];for(var b=0;256>b;b++){a=b;for(var c=0;8>c;c++)a=1&a?3988292384^a>>>1:a>>>1;this.crcTable_[b]=a}},a.prototype.checksum=function(a){return this.init(),this.update(a),this.finish()},a.prototype.init=function(){this.crcTable_||this.generateCrc32Table_(),this.crc_=-1},a.prototype.update=function(a){for(var b=Object.keys(a),c=0,d=b.length;d>c;++c)this.crc_=this.crc_>>>8^this.crcTable_[255&(this.crc_^a[c])]},a.prototype.finish=function(){return(-1^this.crc_)>>>0},a.prototype.serialize=function(a,b){return b.writeUInt32(a)},a.prototype.unserialize=function(a){return a.readUInt32()},a}(),Peeracle.DataSource=function(){function a(){this.offset=0,this.length=0}return a.prototype.read=function(){},a.prototype.seek=function(){},a.prototype.fetchBytes=function(){},a}(),Peeracle.DataSource.File=function(){function a(a){this.handle_=a,this.offset=0,this.length="string"!=typeof a?a.size:-1}var b=Peeracle.DataSource;return a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.prototype.read=function(a){this.offset+=a},a.prototype.seek=function(a){this.offset=a},a.prototype.fetchBytes=function(a,b){if(this.length>-1&&this.offset+a>this.length)return void b(null);var c=new FileReader;c.onload=function(a){b(new Uint8Array(a.target.result))},c.readAsArrayBuffer(this.handle_.slice(this.offset,this.offset+a))},a}(),Peeracle.DataSource.Http=function(){function a(a){this.offset=0,this.length=0,this.url_=a}var b=Peeracle.DataSource;return a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.prototype.read=function(a){this.offset+=a},a.prototype.seek=function(a){this.offset=a},a.prototype.fetchBytes=function(a,b){var c=new XMLHttpRequest,d=this.offset+"-"+(this.offset+(a-1));c.open("GET",this.url_),c.setRequestHeader("Range","bytes="+d),c.responseType="arraybuffer",c.onload=function(){if(206===c.status){var a=new Uint8Array(c.response);return void b(a)}b(null)},c.send()},a}(),Peeracle.Listenable=function(){function a(){this.listeners={}}return a.prototype.on=function(a,b){this.listeners[a]=this.listeners[a]||[],this.listeners[a].push(b)},a.prototype.once=function(a,b){function c(){d.off(a,c),b.apply(null,arguments)}var d=this;c.__originalListener=b,this.on(a,c)},a.prototype.off=function(a,b){this.listeners[a]&&(b?this.listeners[a]=this.listeners[a].filter(function(a){return a!==b&&a.__originalListener!==b}):delete this.listeners[a])},a.prototype.emit=function(a){if(this.listeners[a]){var b=[].slice.call(arguments,1);this.listeners[a].forEach(function(a){a.apply(null,b)})}},a}(),Peeracle.Media=function(){function a(){this.mimeType=null,this.timecodeScale=null,this.duration=null,this.tracks=null,this.cues=null,this.width=null,this.height=null,this.numChannels=null,this.samplingFrequency=null,this.bitDepth=null}return a.createInstance=function(b,c){var d=[];for(var e in a)a.hasOwnProperty(e)&&a[e].hasOwnProperty("checkHeader")&&d.push(a[e]);if(!d.length)return void c(null);var f=0;d[f].checkHeader(b,function g(a){return a?void c(a):++f>=d.length?void c(null):void d[f].checkHeader(b,g)})},a.prototype.getInitSegment=function(){throw"Media: method getInitSegment(cb) not implemented"},a.prototype.getMediaSegment=function(){throw"Media: method getMediaSegment(cb) not implemented"},a}(),Peeracle.Media.WebM=function(){function a(a){this.dataSource_=a,this.clusterTag_=null,this.infoTag_=null,this.tracksTag_=null,this.cuesTag_=null,this.seekHeadTag_=null,this.mimeType="",this.timecodeScale=-1,this.duration=-1,this.tracks=[],this.width=-1,this.height=-1,this.numChannels=-1,this.samplingFrequency=-1,this.bitDepth=-1,this.cues=[]}var b=Peeracle.Media;return a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.checkHeader=function(b,c){b.seek(0),b.fetchBytes(4,function(d){return d&&4===d.length&&26===d[0]&&69===d[1]&&223===d[2]&&163===d[3]?void c(new a(b)):void c(null)})},a.prototype.getTrack_=function(a){for(var b=0;b<this.tracks.length;++b)if(this.tracks[b].type===a)return this.tracks[b];return null},a.prototype.parseInfoTag_=function(a,b,c){"2ad7b1"===a.str?(this.timecodeScale=this.readUInt_(b,c+a.headerSize,a.dataSize),console.log("TimecodeScale: ",this.timecodeScale)):"4489"===a.str&&(this.duration=this.readFloat_(b,c+a.headerSize,a.dataSize),console.log("Duration: ",this.duration))},a.prototype.parseInfos_=function(a){this.readTagBytes_(this.infoTag_,function(b){for(var c=this.infoTag_.headerSize,d=this.readBufferedTag_(c,b);d;)this.parseInfoTag_(d,b,c),c+=d.headerSize+d.dataSize,d=this.readBufferedTag_(c,b);a()}.bind(this))},a.prototype.parseTracks_=function(a){this.readTagBytes_(this.tracksTag_,function(b){for(var c=this.tracksTag_.headerSize,d=this.readBufferedTag_(c,b);d;){if("ae"!==d.str)return;for(var e={id:-1,type:-1,codec:"",width:-1,height:-1,numChannels:-1,samplingFrequency:-1,bitDepth:-1},f=c+d.headerSize,g=this.readBufferedTag_(f,b);g;){if("d7"===g.str)e.id=this.readUInt_(b,f+g.headerSize,g.dataSize);else if("83"===g.str)e.type=this.readUInt_(b,f+g.headerSize,g.dataSize);else if("86"===g.str)e.codec=this.readString_(b,f+g.headerSize,g.dataSize);else if("e0"===g.str)for(var h=f+g.headerSize,i=this.readBufferedTag_(h,b);i&&(-1!==e.width||"b0"!==i.str&&"54b0"!==i.str?-1!==e.height||"ba"!==i.str&&"54ba"!==i.str||(e.height=this.readUInt_(b,h+i.headerSize,i.dataSize)):e.width=this.readUInt_(b,h+i.headerSize,i.dataSize),h+=i.headerSize+i.dataSize,!(h>f+g.headerSize+g.dataSize));)i=this.readBufferedTag_(h,b);else if("e1"===g.str)for(var j=f+g.headerSize,k=this.readBufferedTag_(j,b);k&&("9f"===k.str?e.numChannels=this.readUInt_(b,j+k.headerSize,k.dataSize):"b5"===k.str?e.samplingFrequency=this.readFloat_(b,j+k.headerSize,k.dataSize):"6264"===k.str&&(e.bitDepth=this.readUInt_(b,j+k.headerSize,k.dataSize)),j+=k.headerSize+k.dataSize,!(j>f+g.headerSize+g.dataSize));)k=this.readBufferedTag_(j,b);if(f+=g.headerSize+g.dataSize,f>c+d.headerSize+d.dataSize)break;g=this.readBufferedTag_(f,b)}if(this.tracks.push(e),c+=d.headerSize+d.dataSize,c>this.tracksTag_.headerSize+this.tracksTag_.dataSize)break;d=this.readBufferedTag_(c,b)}console.log(this.tracks),this.width=-1,this.height=-1,this.numChannels=-1,this.samplingFrequency=-1,this.bitDepth=-1;var l=this.getTrack_(1);l&&(this.width=l.width,this.height=l.height);var m=this.getTrack_(2);m&&(this.numChannels=m.numChannels,this.samplingFrequency=m.samplingFrequency,this.bitDepth=m.bitDepth),this.createMimeType_(),a()}.bind(this))},a.prototype.parseCues_=function(a){this.readTagBytes_(this.cuesTag_,function(b){for(var c=this.cuesTag_.headerSize,d=this.readBufferedTag_(c,b);d;){if("bb"!==d.str)return;for(var e={timecode:-1,track:-1,clusterOffset:-1},f=c+d.headerSize,g=this.readBufferedTag_(f,b);g;){if("b3"===g.str)e.timecode=this.readUInt_(b,f+g.headerSize,g.dataSize);else if("b7"===g.str)for(var h=f+g.headerSize,i=this.readBufferedTag_(h,b);i&&("f7"===i.str?e.track=this.readUInt_(b,h+i.headerSize,i.dataSize):"f1"===i.str&&(e.clusterOffset=this.readUInt_(b,h+i.headerSize,i.dataSize)),h+=i.headerSize+i.dataSize,!(h>f+g.headerSize+g.dataSize));)i=this.readBufferedTag_(h,b);if(f+=g.headerSize+g.dataSize,f>c+d.headerSize+d.dataSize)break;g=this.readBufferedTag_(f,b)}if(this.cues.push(e),c+=d.headerSize+d.dataSize,c>this.cuesTag_.headerSize+this.cuesTag_.dataSize)break;d=this.readBufferedTag_(c,b)}a()}.bind(this))},a.prototype.getInitSegment=function(a){this.dataSource_.seek(0),this.readNextTag_(function(b){return b&&"1a45dfa3"===b.str?(this.dataSource_.read(b.dataSize),console.log("Found EBML:",b),void this.readNextTag_(function c(d){return d?"18538067"!==d.str?(this.dataSource_.read(d.dataSize),void this.readNextTag_(c.bind(this))):(console.log("Found Segment:",d),void this.readNextTag_(function e(c){if(!c){if(this.clusterTag_)if(this.infoTag_)if(this.tracksTag_){if(!this.cuesTag_)return console.err("No cues tag found"),void a(null);if(!this.seekHead_)return console.err("No seekhead tag found"),void a(null)}else console.err("No tracks tag found"),a(null);else console.err("No info tag found"),a(null);else console.err("No cluster tag found"),a(null);return void this.parseInfos_(function(){this.parseTracks_(function(){this.parseCues_(function(){b.dataSize=this.clusterTag_.headerOffset-b.headerSize,this.readTagBytes_(b,function(b){a(b)}.bind(this))}.bind(this))}.bind(this))}.bind(this))}"1f43b675"!==c.str||this.clusterTag_?"1549a966"!==c.str||this.infoTag_?"1654ae6b"!==c.str||this.tracksTag_?"1c53bb6b"!==c.str||this.cuesTag_?"114d9b74"!==c.str||this.seekHeadTag_||(this.seekHead_=c.headerOffset):this.cuesTag_=c:this.tracksTag_=c:this.infoTag_=c:this.clusterTag_=c,this.dataSource_.read(c.dataSize),this.readNextTag_(e.bind(this))}.bind(this))):void a(null)}.bind(this))):void a(null)}.bind(this))},a.prototype.getMediaSegment=function(a,b){for(var c=0,d=this.cues.length;d>c;++c){var e=this.cues[c];if(e.timecode===a)return this.dataSource_.seek(this.seekHead_+e.clusterOffset),void this.readNextTag_(function(a){this.readTagBytes_(a,function(a){b(a)})}.bind(this))}b(null)},a.prototype.createMimeType_=function(){for(var a=!1,b=[],c="",d=0,e=this.tracks.length;e>d;++d){var f=this.tracks[d];1===f.type&&(a=!0),"V_VP8"===f.codec?b.push("vp8"):"V_VP9"===f.codec?b.push("vp9"):"A_VORBIS"===f.codec?b.push("vorbis"):"A_OPUS"===f.codec&&b.push("opus")}c=a?"video/webm":"audio/webm";for(var g=c+';codecs="',h=0;h<b.length;++h)g+=b[h],h+1!==b.length&&(g+=",");this.mimeType=g+'"'},a.prototype.readVariableInt_=function(a,b,c){var d,e=1,f=128,g=1;if(d=a[b],!d)return null;for(;c>=e&&!(d&f);)e++,f>>=1;if(e>c)return null;for(d&=~f;g++<e;)d=d<<8|a[++b];return{length:e,value:d}},a.prototype.readBufferedTag_=function(a,b){var c=this.readVariableInt_(b,a,4);if(!c)return null;var d={};return d.id=c.value|1<<7*c.length,d.str=d.id.toString(16),d.headerSize=c.length,c=this.readVariableInt_(b,a+d.headerSize,8),d.dataSize=c.value,d.headerSize+=c.length,d},a.prototype.readNextTag_=function(a){var b=this.dataSource_.offset;this.dataSource_.fetchBytes(12,function(c){if(!c)return void a(null);var d=this.readBufferedTag_(0,c);this.dataSource_.read(d.headerSize),d.headerOffset=b,a(d)}.bind(this))},a.prototype.readFloat4_=function(a,b){for(var c=0,d=0;4>d;++d)c<<=8,c|=255&a[b+d];var e=c>>31,f=(c>>23&255)-127,g=8388607&c;if(f>-127){if(128===f)return 0===g?0===e?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:0/0;g|=8388608}else{if(0===g)return 0;f=-126}var h=Math.pow(-1,e)*g*Math.pow(2,-23)*Math.pow(2,f);return h},a.prototype.readFloat8_=function(a,b){var c=a[b]>>7&1,d=((127&a[b])<<4|a[b+1]>>4&15)-1023,e=0,f=Math.pow(2,48);e+=(15&a[b+1])*f;for(var g=2;8>g;++g)f=Math.pow(2,8*(8-g-1)),e+=(255&a[b+g])*f;if(d>-1023){if(1024===d)return 0===e?0===c?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:0/0;e+=4503599627370496}else{if(0===e)return 0;d=-1022}var h=Math.pow(-1,c)*e*Math.pow(2,-52)*Math.pow(2,d);return h},a.prototype.readFloat_=function(a,b,c){return 4===c?this.readFloat4_(a,b):8===c?this.readFloat8_(a,b):0},a.prototype.readUInt_=function(a,b,c){if(1>c||c>8)return null;for(var d=0,e=0;c>e;++e)d<<=8,d|=255&a[b+e];return d},a.prototype.readString_=function(a,b,c){if(1>c||c>8)return null;for(var d="",e=0;c>e;++e)d+=String.fromCharCode(a[b+e]);return d},a.prototype.readTagBytes_=function(a,b){this.dataSource_.seek(a.headerOffset),this.dataSource_.fetchBytes(a.headerSize+a.dataSize,function(c){return c?(this.dataSource_.read(a.headerSize+a.dataSize),void b(c)):void b(null)}.bind(this))},a}(),Peeracle.Metadata=function(){function a(){this.id=null,this.crypto_=null,this.cryptoId="crc32",this.trackers=[],this.minChunkSize=32768,this.maxChunkSize=262144,this.timecodeScale=-1,this.duration=-1,this.streams=[]}var b=Peeracle.Crypto;return a.prototype.getId=function(){return this.id?this.id:(this.crypto_||(this.crypto_=b.createInstance(this.cryptoId)),this.crypto_.init(),this.id=this.crypto_.finish(),this.id)},a.prototype.calculateChunkSize=function(a){var b,c,d=a.cues,e=0,f=0;for(b=0,c=d.length;c>b;++b){var g=d[b];e+=g.clusterOffset-f,f=g.clusterOffset}var h=e/d.length;for(b=this.minChunkSize;b<this.maxChunkSize&&h>b;b*=2);return console.log(h),b},a.prototype.addStream=function(a,c){a.getInitSegment(function(d){var e={type:1,mimeType:a.mimeType,bandwidth:0,width:a.width,height:a.height,numChannels:a.numChannels,samplingFrequency:a.samplingFrequency,chunksize:this.calculateChunkSize(a),init:d,segments:[]};-1===this.timecodeScale&&(this.timecodeScale=a.timecodeScale),-1===this.duration&&(this.duration=a.duration);var f=a.cues.length,g=0;if(!f)return this.streams.push(e),void c();var h=a.cues[g].timecode;a.getMediaSegment(h,function i(d){if(!d)return this.streams.push(e),void c();var j=d.length,k=e.chunksize;this.crypto_||(this.crypto_=b.createInstance(this.cryptoId));for(var l={timecode:h,length:j,checksum:this.crypto_.checksum(d),chunks:[]},m=0;j>m;m+=k){var n=d.subarray(m,m+k);l.chunks.push(this.crypto_.checksum(n)),k>j-m&&(k=j-m)}return e.segments.push(l),++g>=f?(this.streams.push(e),void c()):(h=a.cues[g].timecode,void a.getMediaSegment(h,i.bind(this)))}.bind(this))}.bind(this))},a}(),Peeracle.Metadata.Serializer=function(){function a(){this.crypto_=null,this.stream_=null}var b=Peeracle.BinaryStream,c=Peeracle.Crypto;return a.prototype.serializeSegment_=function(a){this.stream_.writeUInt32(a.timecode),this.stream_.writeUInt32(a.length),this.crypto_.serialize(a.checksum,this.stream_),this.stream_.writeUInt32(a.chunks.length);for(var b=0,c=a.chunks.length;c>b;++b)this.crypto_.serialize(a.chunks[b],this.stream_)},a.prototype.serializeStream_=function(a){this.stream_.writeByte(a.type),this.stream_.writeString(a.mimeType),this.stream_.writeUInt32(a.bandwidth),this.stream_.writeInt32(a.width),this.stream_.writeInt32(a.height),this.stream_.writeInt32(a.numChannels),this.stream_.writeInt32(a.samplingFrequency),this.stream_.writeUInt32(a.chunksize),this.stream_.writeUInt32(a.init.length),this.stream_.writeBytes(a.init),this.stream_.writeUInt32(a.segments.length);for(var b=0,c=a.segments.length;c>b;++b)this.serializeSegment_(a.segments[b])},a.prototype.serializeStreams_=function(a){var b=a.streams;this.stream_.writeUInt32(b.length);for(var c=0;c<b.length;++c){var d=b[c];this.serializeStream_(d)}},a.prototype.serializeTrackers_=function(a){var b=a.trackers;this.stream_.writeUInt32(b.length);for(var c=0;c<b.length;++c)this.stream_.writeString(b[c])},a.prototype.serializeHeader_=function(a){if(this.crypto_=c.createInstance(a.cryptoId),!this.crypto_)throw"Unknown checksum "+a.cryptoId;this.stream_.writeUInt32(1347568460),this.stream_.writeUInt32(2),this.stream_.writeString(a.cryptoId),this.stream_.writeUInt32(a.timecodeScale),this.stream_.writeFloat8(a.duration)},a.prototype.allocate_=function(a){var b=8+(a.cryptoId.length+1)+4+8,c=a.trackers;b+=4;for(var d=0;d<c.length;++d)b+=c[d].length+1;var e=a.streams;b+=4;for(var f=0;f<e.length;++f){var g=e[f];b+=1+(g.mimeType.length+1)+4+4+4+4+4+4+4+g.init.length;var h=g.segments;b+=4;for(var i=0;i<h.length;++i){b+=12;var j=h[i].chunks;b+=4;for(var k=0;k<j.length;++k)b+=4}}return new Uint8Array(b)},a.prototype.serialize=function(a){return this.stream_=new b(this.allocate_(a)),this.serializeHeader_(a),this.serializeTrackers_(a),this.serializeStreams_(a),this.stream_.bytes},a}(),Peeracle.Metadata.Unserializer=function(){function a(){this.crypto_=null,this.stream_=null}var b=Peeracle.Crypto;return a.prototype.unserializeSegment_=function(){var a={};a.timecode=this.stream_.readUInt32(),a.length=this.stream_.readUInt32(),a.checksum=this.crypto_.unserialize(this.stream_),a.chunks=[];for(var b=this.stream_.readUInt32(),c=0;b>c;++c){var d=this.crypto_.unserialize(this.stream_);a.chunks.push(d)}return a},a.prototype.unserializeStream_=function(){var a={};a.type=this.stream_.readByte(),a.mimeType=this.stream_.readString(),a.bandwidth=this.stream_.readUInt32(),a.width=this.stream_.readInt32(),a.height=this.stream_.readInt32(),a.numChannels=this.stream_.readInt32(),a.samplingFrequency=this.stream_.readInt32(),a.chunksize=this.stream_.readUInt32();var b=this.stream_.readUInt32();a.init=new Uint8Array(b);for(var c=0;b>c;++c)a.init[c]=this.stream_.readByte();a.segments=[];for(var d=this.stream_.readUInt32(),e=0;d>e;++e){var f=this.unserializeSegment_();a.segments.push(f)}return a},a.prototype.unserializeStreams_=function(){for(var a=[],b=this.stream_.readUInt32(),c=0;b>c;++c){var d=this.unserializeStream_();a.push(d)}return a},a.prototype.unserializeTrackers_=function(){for(var a=this.stream_.readUInt32(),b=[],c=0;a>c;++c)b.push(this.stream_.readString());return b},a.prototype.unserializeHeader_=function(){var a={};if(a.magic=this.stream_.readUInt32(),1347568460!==a.magic)throw"Wrong file header";if(a.version=this.stream_.readUInt32(),a.cryptoId=this.stream_.readString(),this.crypto_=b.createInstance(a.cryptoId),!this.crypto_)throw"Unknown checksum "+a.cryptoId;return a.timecodeScale=this.stream_.readUInt32(),a.duration=this.stream_.readFloat8(),a},a.prototype.unserialize=function(a,b){this.stream_=a;var c=this.unserializeHeader_(),d=this.unserializeTrackers_(),e=this.unserializeStreams_();b.timecodeScale=c.timecodeScale,b.duration=c.duration,b.trackers=d,b.streams=e},a}(),Peeracle.Peer=function(){function a(){}var b=Peeracle.Listenable;return a.prototype=Object.create(b.prototype),a}(),Peeracle.PeerConnection=function(){function a(){}var b=Peeracle.Listenable;return a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a}(),Peeracle.Tracker=function(){var a={};return a}(),Peeracle.Tracker.Client=function(){function a(){this.url_=null,this.ws_=null}var b=Peeracle.Listenable;a.prototype=Object.create(b.prototype),a.prototype.constructor=a;var c=function(){console.log("[Peeracle.Tracker.Client] onOpen"),this.ws_.send(new Uint8Array([0,0]))},d=function(a){var b=a.data;console.log("[Peeracle.Tracker.Client] onMessage",b)},e=function(){console.log("[Peeracle.Tracker.Client] onError")},f=function(a){var b=a.code,c=a.reason;console.log("[Peeracle.Tracker.Client] onClose",b,c)};return a.prototype.connect=function(a){this.url_=a,this.ws_=new WebSocket(this.url_,"prcl-0.0.1",this.url_),this.ws_.onopen=c.bind(this),this.ws_.onmessage=d.bind(this),this.ws_.onerror=e.bind(this),this.ws_.onclose=f.bind(this)},a}(this.Tracker),Peeracle.Tracker.Message=function(){function a(c){this.type=a.Type.None,this.stream_=null,c&&typeof c===ArrayBuffer&&(this.stream_=new b(c))}var b=Peeracle.BinaryStream;return a.Type={None:0,Hello:1,Welcome:2},a}(),Peeracle.Utils=function(){function a(){}return Math.trunc=Math.trunc||function(a){return 0>a?Math.ceil(a):Math.floor(a)},a.trunc=function(a){return Math.trunc(a)},a}();